<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Live Chat Embed</title>
<style>
  iframe{border:0;width:100%;height:100vh}
  .offline-message{display:flex;align-items:center;justify-content:center;
                   height:100vh;background:#f0f0f0;color:#666;text-align:center}
  .status{position:absolute;top:10px;right:10px;background:rgba(0,0,0,.7);
          color:#fff;padding:10px;border-radius:5px;font-size:12px;z-index:1000}
</style>
</head>
<body>
  <div id="status" class="status" hidden></div>
  <iframe id="chatFrame" title="YouTube live‑chat" hidden></iframe>
  <div id="offlineMessage" class="offline-message">
     <div><h2>Live Chat Currently Offline</h2>
     <p>Live chat is available during Sunday services:<br><strong>9 & 11 AM</strong></p></div>
  </div>

<script>
const N8N_WEBHOOK_URL = "https://n8n.hazardhouse.ai/webhook/youtube-live-id";
const CHECK_INTERVAL  = 60_000;   // 1 min
const FETCH_INTERVAL  = 5 * 60_000; // 5 min
let currentVideoId = null, lastFetchTime = 0;

const iframe = document.getElementById('chatFrame');
const status  = document.getElementById('status');
const offline = document.getElementById('offlineMessage');

function azTime(){ return new Date().toLocaleString('en-US',
                          {hour12:false,timeZone:'America/Phoenix'}); }

function showStatus(msg){
  status.textContent = `${azTime()} AZ – ${msg}`;
  status.hidden = false;
  setTimeout(()=>status.hidden=true, 5_000);
}

async function fetchVideoId(){
  const r = await fetch(N8N_WEBHOOK_URL);
  if(!r.ok) throw new Error(`HTTP ${r.status}`);
  const {videoId} = await r.json();
  if(videoId){ currentVideoId = videoId; lastFetchTime = Date.now();
               showStatus(`Got ID ${videoId}`); return true; }
  showStatus('Webhook returned no ID'); return false;
}

function inServiceWindow(d=new Date()){
  const t = d.toLocaleString('en-US',{hour12:false,timeZone:'America/Phoenix'});
  const [h,m] = t.split(',')[1].trim().split(':').map(Number);
  const mins = h*60+m;
  return d.getUTCDay()===0 &&              // Sunday
         ((mins>= 9*60 && mins<10*60+30) || (mins>=11*60 && mins<12*60+30));
}

async function updateChat(){
  if(inServiceWindow(new Date())){
    if(!currentVideoId || Date.now()-lastFetchTime>FETCH_INTERVAL) await fetchVideoId();
    if(currentVideoId){
      const embedDomain = location.hostname;
      const url = `https://www.youtube.com/live_chat?v=${currentVideoId}&embed_domain=${embedDomain}`;
      if(iframe.src!==url){ iframe.src=url; showStatus('Chat online'); }
      iframe.hidden=false; offline.hidden=true;
    }else{ iframe.hidden=true; offline.hidden=false; }
  }else{
    iframe.hidden=true; iframe.src=''; offline.hidden=false; currentVideoId=null;
  }
}

updateChat();                       // initial run
setInterval(updateChat, CHECK_INTERVAL);
document.addEventListener('visibilitychange', ()=>!document.hidden&&updateChat());

iframe.addEventListener('load', ()=>console.log('chat iframe loaded'));
iframe.addEventListener('error',e=>console.error('iframe error',e));
</script>
</body>
</html>
